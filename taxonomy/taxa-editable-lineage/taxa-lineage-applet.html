<html>

<head>
   <!-- Applet Name: "Taxa Lineage Helper" -->
   <!-- Category: "annotator-tools" -->
   <link rel="stylesheet" type="text/css" href="/static/components.css">
   <script src="/static/annotation.js"></script>
   <script src="/static/components.js"></script>
   <script src="/static/util.js"></script>

   <style>
      body {
         border: 1px solid;
      }
   </style>


</head>

<body style="padding-top: 0; "> <!--background: rgba(0, 7, 13,.95);-->
   <template id="attr-taxa-panel">
      <div style="width:95%; margin: 0 auto;">
         <div id="taxa-tree-container">
            <!---->
         </div>
         <div id="attr-panel-container" hidden>
            <attribute-panel id="attributePanel"></attribute-panel>
         </div>
         <div id="attr-panel-message" class="text-bold py-1"></div>
         <button id="apply-selection" class="btn btn-clear col-12 clickable background-green">
            Apply tree selection
         </button>
      </div>
   </template>


   <template id="taxa-tree">
      <style>
         .autocomplete {
            position: absolute;
            max-height: 20em;
            overflow-x: hidden;
            overflow-y: auto;
            margin-top: 30px;
            width: 15em;
         }

         .radio-slide-wrap .col-8 {
            width: auto !important;
         }

         .autocomplete>div.autocomplete-no-bg:hover {
            background: transparent !important;
         }

         .datalist {
            max-height: 10em;
            border: 0 none;
            overflow-x: hidden;
            overflow-y: auto;
            z-index: 1000;
            box-sizing: border-box;
            border: 1px solid rgba(50, 50, 50, 0.6);
            position: absolute;
            right: 0;
            margin-top: 33px;
            background: rgba(38, 46, 61) !important;
            border: 1px solid rgba(162, 175, 205, .7);
            padding: 5px;
         }

         .datalist option {
            font-size: 0.8em;
            padding: 0.3em 1em;

            color: white !important;
            cursor: pointer;
         }

         .datalist option:hover,
         .datalist option:focus {
            outline: 0 none;
            background: #696cff !important;
            cursor: pointer;
         }

         .scopedInput {
            width: 15px;
            background: transparent;
            border: none;
            box-shadow: none;
            margin-left: -10px;
         }

         .scopedInput:focus,
         .scopedInput:active {
            border: none;
            box-shadow: none;
         }

         .rankLabel {
            width: 75px;
         }

         .taxa-scoped-list-button {
            background: rgb(21, 27, 40);
            border-top-left-radius: 0 !important;
            border-bottom-left-radius: 0 !important;
         }

         .taxa-scoped-list-button:active,
         .taxa-scoped-list-button:focus,
         .taxa-scoped-list-button:hover {
            background: rgba(38, 46, 61, .7) !important;
         }

         .taxa-scoped-list-button.open {
            z-index: 1002;
            border: 1px solid rgba(162, 175, 205, .7);
            border-bottom: none;
            background: rgb(38, 46, 61) !important;
            z-index: 1002;
            border-bottom-right-radius: 0 !important;
         }

         .warning-toast {
            position: absolute;
            bottom: 0;
            border: 1px solid black;
            background: rgba(38, 46, 61) !important;
            width: 50%;
            z-index: 1001;
         }

         #warningMessage {
            border: 1px solid rgba(162, 175, 205, .7);
            padding: 5px;
         }

         #searchType {
            font-size: 9px;
         }

      </style>
      <div>

         <!-- on change clear taxa tree, and run search -->
         <div class="d-flex" style="padding-bottom: 8px;">
            <div class="d-flex flex-items-center col-9" style="padding-right: 1px;">
               <text-input placeholder="Enter search term." class="col-12 f2" name=""
                  id="source-data--search"></text-input>
               <button id="source-data--search-go" class="btn btn-small btn-clear btn-outline" style="width: auto;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="no-fill">
                     <circle cx="11" cy="11" r="8" />
                     <line x1="21" y1="21" x2="16.65" y2="16.65" />
                  </svg>
               </button>
            </div>
            <bool-input id="searchType" class="px-1 col-6" name="" on-text="Scientific" off-text="Common"></bool-input>
         </div>
         
         <div id="goBack" class="text-underline clickable f2 text-gray" hidden>
            Back
         </div>

         <!-- Potentially error message in toast? -->
         <!-- <div id="warning-message--not-found" class="py-3 px-3 warning-toast" hidden>
            <div class="col-12 text-right py-1">x</div>
            <div class="pb-3 f2">
               No record found for {rank} value "{name}" cannot be found in our database.<br/><br/>
               Do you want to maintain the current heirarchy fields, or discard?
            </div>
            <div class="d-flex flex-justify-between">
               <button class="btn btn-clear btn-small col-6">Keep</button>
               <button class="btn btn-clear btn-outline text-red btn-small col-6">Discard</button>
            </div>
         </div> -->

         <div class="py-3" id="warningMessage" hidden>
            <div id="dismissMessage" class="col-12 text-right py-1 f2 text-gray clickable">x Dismiss</div>
            <div>
               No record matching <span id="warningMessage_rank"></span> "<span id="warningMessage_rankValue"></span>".
               Is it spelled correctly?<br /><br />
               <!-- <div id="dismissMessageClear" class="btn btn-small btn-clear btn-outline">Clear value</div> -->
               <div id="suggestionListDiv" hidden>
                  Did you mean one of these instead?
                  <div id="suggestionList"></div>
               </div>
            </div>
         </div>

         <div id="taxa-tree" class="border-top">
            <div id="taxa-tree--message" hidden></div>
            <div id="taxa-tree--list" class="">
               <div id="taxa-item-row" style="margin-left: 0px;">
                  <div class="leaves-edit py-1 d-flex">
                     <div class="rankLabel py-2">
                        <span id="taxa-item--rank" class="text-gray f2 css-truncate">Kingdom</span>
                     </div>
                     <div class="d-flex flex-row f1 flex-items-center flex-justify-between">
                        <div class="d-flex flex-align-center position-relative">
                           <input id="taxa-item--Kingdom" placeholder="not set"
                              class="px-1 input-sm radius-3 form-control f2 taxa-list-item" 
                              rank="Kingdom" level="0" list="allKingdom">
                           <div id="allKingdom" class="autocomplete" hidden></div>

                           <div id="scopedKingdomInputLabel" for="scopedKingdomInput"
                              class="px-2 py-2 rounded-2 taxa-scoped-list-button clickable">
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round" class="no-fill">
                                 <circle cx="18" cy="18" r="3" />
                                 <circle cx="6" cy="6" r="3" />
                                 <path d="M6 21V9a9 9 0 0 0 9 9" />
                              </svg>
                           </div>
                           <div id="parentScopedKingdom" class="datalist" hidden></div>
                        </div>
                     </div>
                  </div>
               </div>
               <div id="taxa-item-row" style="margin-left: 22px;">
                  <div class="leaves-edit py-1 d-flex">
                     <div class="rankLabel py-2">
                        <span id="taxa-item--rank" class="text-gray f2 css-truncate">Phylum</span>
                     </div>
                     <div class="d-flex flex-row f1 flex-items-center flex-justify-between">
                        <div class="d-flex flex-align-center position-relative">
                           <input id="taxa-item--Phylum" placeholder="not set"
                              class="px-1 input-sm radius-3 form-control f2 taxa-list-item" 
                              rank="Phylum" level="1" list="allPhylum">
                           <div id="allPhylum" class="autocomplete" hidden></div>
                           <div id="scopedPhylumInputLabel" for="scopedPhylumInput"
                              class="px-2 py-2 rounded-2 taxa-scoped-list-button clickable">
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round" class="no-fill">
                                 <circle cx="18" cy="18" r="3" />
                                 <circle cx="6" cy="6" r="3" />
                                 <path d="M6 21V9a9 9 0 0 0 9 9" />
                              </svg>
                           </div>
                           <div id="parentScopedPhylum" class="datalist" hidden></div>
                        </div>
                     </div>
                  </div>
               </div>
               <div id="taxa-item-row" style="margin-left: 42px;">
                  <div class="leaves-edit py-1 d-flex">
                     <div class="rankLabel py-2">
                        <span id="taxa-item--rank" class="text-gray f2 css-truncate">Class</span>
                     </div>
                     <div class="d-flex flex-row f1 flex-items-center flex-justify-between">
                        <div class="d-flex flex-align-center position-relative">
                           <input id="taxa-item--Class" placeholder="not set"
                              class="px-1 input-sm radius-3 form-control f2 taxa-list-item" 
                              rank="Class" level="2" list="allClass">
                           <div id="allClass" class="autocomplete" hidden></div>
                           <div id="scopedClassInputLabel" for="scopedClassInput"
                              class="px-2 py-2 rounded-2 taxa-scoped-list-button clickable">
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round" class="no-fill">
                                 <circle cx="18" cy="18" r="3" />
                                 <circle cx="6" cy="6" r="3" />
                                 <path d="M6 21V9a9 9 0 0 0 9 9" />
                              </svg>
                           </div>
                           <div id="parentScopedClass" class="datalist" hidden></div>
                        </div>
                     </div>
                  </div>
               </div>
               <div id="taxa-item-row" style="margin-left: 64px;">
                  <div class="leaves-edit py-1 d-flex">
                     <div class="rankLabel py-2">
                        <span id="taxa-item--rank" class="text-gray f2 css-truncate">Order</span>
                     </div>
                     <div class="d-flex flex-row f1 flex-items-center flex-justify-between">
                        <div class="d-flex flex-align-center position-relative">
                           <input id="taxa-item--Order" placeholder="not set"
                              class="px-1 input-sm radius-3 form-control f2 taxa-list-item" 
                              rank="Order" level="3" list="allOrder">
                           <div id="allOrder" class="autocomplete" hidden></div>
                           <div id="scopedOrderInputLabel" for="scopedOrderInput"
                              class="px-2 py-2 rounded-2 taxa-scoped-list-button clickable">
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round" class="no-fill">
                                 <circle cx="18" cy="18" r="3" />
                                 <circle cx="6" cy="6" r="3" />
                                 <path d="M6 21V9a9 9 0 0 0 9 9" />
                              </svg>
                           </div>
                           <div id="parentScopedOrder" class="datalist" hidden></div>
                        </div>
                     </div>
                  </div>
               </div>
               <div id="taxa-item-row" style="margin-left: 86px;">
                  <div class="leaves-edit py-1 d-flex">
                     <div class="rankLabel py-2">
                        <span id="taxa-item--rank" class="text-gray f2 css-truncate">Family</span>
                     </div>
                     <div class="d-flex flex-row f1 flex-items-center flex-justify-between">
                        <div class="d-flex flex-align-center position-relative">
                           <input id="taxa-item--Family" placeholder="not set"
                              class="px-1 input-sm radius-3 form-control f2 taxa-list-item" 
                              rank="Family" level="4" list="allFamily">
                           <div id="allFamily" class="autocomplete" hidden></div>
                           <div id="scopedFamilyInputLabel" for="scopedFamilyInput"
                              class="px-2 py-2 rounded-2 taxa-scoped-list-button clickable">
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round" class="no-fill">
                                 <circle cx="18" cy="18" r="3" />
                                 <circle cx="6" cy="6" r="3" />
                                 <path d="M6 21V9a9 9 0 0 0 9 9" />
                              </svg>
                           </div>
                           <div id="parentScopedFamily" class="datalist" hidden></div>
                        </div>
                     </div>
                  </div>
               </div>
               <div id="taxa-item-row" style="margin-left: 108px;">
                  <div class="leaves-edit py-1 d-flex">
                     <div class="rankLabel py-2">
                        <span id="taxa-item--rank" class="text-gray f2 css-truncate">Genus</span>
                     </div>
                     <div class="d-flex flex-row f1 flex-items-center flex-justify-between">
                        <div class="d-flex flex-align-center position-relative">
                           <input id="taxa-item--Genus" placeholder="not set"
                              class="px-1 input-sm radius-3 form-control f2 taxa-list-item" 
                              rank="Genus" level="5" list="allGenus">
                           <div id="allGenus" class="autocomplete" hidden></div>
                           <div id="scopedGenusInputLabel" for="scopedGenusInput"
                              class="px-2 py-2 rounded-2 taxa-scoped-list-button clickable">
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round" class="no-fill">
                                 <circle cx="18" cy="18" r="3" />
                                 <circle cx="6" cy="6" r="3" />
                                 <path d="M6 21V9a9 9 0 0 0 9 9" />
                              </svg>
                           </div>
                           <div id="parentScopedGenus" class="datalist" hidden></div>
                        </div>
                     </div>
                  </div>
               </div>
               <div id="taxa-item-row" style="margin-left: 130px;">
                  <div class="leaves-edit py-1 d-flex">
                     <div class="rankLabel py-2">
                        <span id="taxa-item--rank" class="text-gray f2 css-truncate">Species</span>
                     </div>
                     <div class="d-flex flex-row f1 flex-items-center flex-justify-between">
                        <div class="d-flex flex-align-center position-relative">
                           <input id="taxa-item--Species" placeholder="not set"
                              class="px-1 input-sm radius-3 form-control f2 taxa-list-item" 
                              rank="Species" level="6" list="allSpecies">
                           <div id="allSpecies" class="autocomplete" hidden></div>
                           <div id="scopedSpeciesInputLabel" for="scopedSpeciesInput"
                              class="px-2 py-2 rounded-2 taxa-scoped-list-button clickable">
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round" class="no-fill">
                                 <circle cx="18" cy="18" r="3" />
                                 <circle cx="6" cy="6" r="3" />
                                 <path d="M6 21V9a9 9 0 0 0 9 9" />
                              </svg>
                           </div>
                           <div id="parentScopedSpecies" class="datalist" hidden></div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </template>


   <script>
      const appletName = "Taxonomy Editable Lineage Applet";
      const projectId = window.location.pathname.split("/")[2];

      const taxaAPI = {
         children: async (id, offset = 1) => {
            const response = await fetch(`https://www.marinespecies.org/rest/AphiaChildrenByAphiaID/${id}?marine_only=true&offset=${offset}`);
            const contentType = response.headers.get("content-type");
            if (response.ok && (contentType && contentType.indexOf("application/json") !== -1)) {
               try {
                  const data = await response.json();
                  return { response, data };
               } catch (err) {
                  console.error(err);
               }

            }
            return { response: { ok: false }, data: null };
         },
         info: async (name, offset = 1) => {
            name = encodeURI(name);
            const response = await fetch(`https://www.marinespecies.org/rest/AphiaRecordsByName/${name}?like=true&marine_only=true&offset=${offset}`);
            const contentType = response.headers.get("content-type");
            if (response.ok && (contentType && contentType.indexOf("application/json") !== -1)) {
               try {
                  const data = await response.json();
                  return { response, data };
               } catch (err) {
                  console.error(err);
               }
            }
            return { response: { ok: false }, data: null };
         },
         infoVernacular: async (name, offset = 1) => {
            name = encodeURI(name);
            const response = await fetch(`https://www.marinespecies.org/rest/AphiaRecordsByVernacular/${name}?like=false&offset=${offset}`);
            const contentType = response.headers.get("content-type");
            if (response.ok && (contentType && contentType.indexOf("application/json") !== -1)) {
               try {
                  const data = await response.json();
                  return { response, data };
               } catch (err) {
                  console.error(err);
               }
            }
            return { response: { ok: false }, data: null };
         },
         recordById: async (id) => {
            const response = await fetch(`https://www.marinespecies.org/rest/AphiaRecordByAphiaID/${id}`);
            const contentType = response.headers.get("content-type");
            if (response.ok && (contentType && contentType.indexOf("application/json") !== -1)) {
               try {
                  const data = await response.json();
                  return { response, data };
               } catch (err) {
                  console.error(err);
               }

            }
            return { response: { ok: false }, data: null };

         },
         classificationById: async (id) => {
            const response = await fetch(`https://www.marinespecies.org/rest/AphiaClassificationByAphiaID/${id}`);
            const contentType = response.headers.get("content-type");
            if (response.ok && (contentType && contentType.indexOf("application/json") !== -1)) {
               try {
                  const data = await response.json();
                  return { response, data };
               } catch (err) {
                  console.error(err);
               }

            }
            return { response: { ok: false }, data: null };

         },
         byTaxonRankID: async (rankId, belongsToId, offset = 1) => {
            const apiString = belongsToId !== null
               ?
               `https://www.marinespecies.org/rest/AphiaRecordsByTaxonRankID/${rankId}?belongsTo=${belongsToId}&offset=${offset}`
               :
               `https://www.marinespecies.org/rest/AphiaRecordsByTaxonRankID/${rankId}?offset=${offset}`;
            console.log(apiString);
            const response = await fetch(apiString);
            const contentType = response.headers.get("content-type");
            if (response.ok && (contentType && contentType.indexOf("application/json") !== -1)) {
               try {
                  const data = await response.json();
                  return { response, data };
               } catch (err) {
                  console.error(err);
               }

            }
            return { response: { ok: false }, data: null };
         },
         idByName: async (name) => {
            //
            name = encodeURI(name);
            const response = await fetch(`https://www.marinespecies.org/rest/AphiaIDByName/${name}?marine_only=true`);
            const contentType = response.headers.get("content-type");
            if (response.ok && (contentType && contentType.indexOf("application/json") !== -1)) {
               try {
                  const data = await response.json();
                  return { response, data };
               } catch (err) {
                  console.error(err);
               }

            }
            return { response: { ok: false }, data: null };
         }
      };

      // const closeApplet = document.getElementById("closeApplet"); // TODO move this inside?

      class ToolsAppletPanelHTML extends tatorUi.components.TatorElement {
         constructor() {
            super();

            const sourceImageDiv = document.createElement("div");
            sourceImageDiv.setAttribute("class", "py-1 d-flex flex-justify-center");
            this._shadow.appendChild(sourceImageDiv);

            this._sourceImageEl = document.createElement("img");
            this._sourceImageEl.style = "max-height: 150px; margin: 5px auto;";
            sourceImageDiv.appendChild(this._sourceImageEl);

            this.imageContainerDiv = document.createElement("div");
            this.imageContainerDiv.setAttribute("class", "col-12");
            this._shadow.appendChild(this.imageContainerDiv);

            this._imagePreview = document.createElement("img");
            this._imagePreview.setAttribute("style", "max-height: 300px; max-width: 100%;");
            this._imagePreview.src = ``;
            this.imageContainerDiv.appendChild(this._imagePreview);

            // this._descriptiveText = document.createElement("div");
            // this._descriptiveText.setAttribute("style", "max-height: 50vh; overflow-y: scroll;");
            // this._descriptiveText.setAttribute("class", "text-gray");
            // this._descriptiveText.hidden = true;
            // this._descriptiveText.innerHTML = `No selection.`;
            // this._shadow.appendChild(this._descriptiveText);

            // 
            var panel = document.getElementById("attr-taxa-panel");
            var panelClone = document.importNode(panel.content, true);
            this._shadow.appendChild(panelClone);

            const taxaContainer = this._shadow.getElementById("taxa-tree-container");
            const taxaPanel = document.getElementById("taxa-tree");
            var taxaPanelClone = document.importNode(taxaPanel.content, true);
            taxaContainer.appendChild(taxaPanelClone);

            this._treeList = this._shadow.getElementById("taxa-tree--list");
            this._treeListMessage = this._shadow.getElementById("taxa-tree--message");

            this.attrPanelContainer = this._shadow.getElementById("attr-panel-container");
            this.taxaPanelContainer = this._shadow.getElementById("taxa-tree-container");

            this._searchInputTimer = null;
            this._searchInput = this._shadow.getElementById("source-data--search");
            this._searchInput._input.classList.remove("col-8");
            this._searchInput._input.classList.add("col-12");
            this._searchGo = this._shadow.getElementById("source-data--search-go");
            this._searchGo.addEventListener("click", this.searchTerm.bind(this));
            this._searchInput.addEventListener("keyup", this.searchEnter.bind(this));

            this._searchTypeBool = this._shadow.getElementById("searchType");
            this._searchTypeBool._legend.hidden = true;
            this._searchTypeBool.setValue(true);

            this._goBack = this._shadow.getElementById("goBack");
            this._goBack.addEventListener("click", this.goBackHistory.bind(this));

            this.dataLayer = {
               term: "",
               data: {}, //named list of properties and their WoRmS record
               searchHistory: []
            };

            this.taxaLevels = new Map();
            this.taxaLevelsRank = new Map();

            this._applyButton = this._shadow.getElementById("apply-selection");
            this._applyButton.addEventListener("click", this.applySelectedPanel.bind(this));
            this._attrPanelMsg = this._shadow.getElementById("attr-panel-message");

            this.rankIdMap = new Map();
            this.rankIdMap
               .set(
                  "Kingdom", 10
               ).set(
                  "Phylum", 30
               ).set(
                  "Class", 60
               ).set(
                  "Order", 100
               ).set(
                  "Family", 140
               ).set(
                  "Genus", 180
               ).set(
                  "Species", 220
               );

            // Do this once to prep for datalist opening
            var keyboardEvent = document.createEvent("KeyboardEvent");
            var initMethod = typeof keyboardEvent.initKeyboardEvent !== 'undefined' ? "initKeyboardEvent" : "initKeyEvent";

            keyboardEvent[initMethod](
               "keyup", // event type : keydown, keyup, keypress
               true, // bubbles
               true, // cancelable
               window, // viewArg: should be window
               false, // ctrlKeyArg
               false, // altKeyArg
               false, // shiftKeyArg
               false, // metaKeyArg
               40, // keyCodeArg : unsigned long the virtual key code, else 0
               0 // charCodeArgs : unsigned long the Unicode character associated with the depressed key, else 0
            );

            // Memoize holders
            this._stashRecords = new Map(); // scientificname:record
            this._stashScopedList = new Map(); // {rankId}_{belongsToId}:[records]

            // List of names to display
            this._levelNames = [];
            this._rankInputs = new Map();
            this._rankIdInputs = new Map();
            this._autoCompleteDivs = new Map();
            this._scopedDataLists = new Map();
            this._dataListTriggers = new Map();
            let count = 0;

            for (let [rankName, val] of this.rankIdMap) {
               this._levelNames.push(rankName);

               const rankInput = this._shadow.getElementById(`taxa-item--${rankName}`);
               this._rankInputs.set(
                  rankName, rankInput
               );

               this._rankIdInputs.set(
                  val, rankInput
               );

               const autocompleteDiv = this._shadow.getElementById(`all${rankName}`);
               this._autoCompleteDivs.set(
                  rankName, autocompleteDiv
               );

               autocompleteDiv.addEventListener("click", () => {
                  // autocompleteDiv.hidden = !autocompleteDiv.hidden;
                  this.hideDataList();
               });

               const dataList = this._shadow.getElementById(`parentScoped${rankName}`);
               this._scopedDataLists.set(
                  rankName, dataList
               );

               const dataListTrigger = this._shadow.getElementById(`scoped${rankName}InputLabel`);
               dataListTrigger.addEventListener("click", (evt) => {
                  const hideToggle = !dataList.hidden;
                  this.hideDataList();
                  dataList.hidden = hideToggle;

                  if(hideToggle){
                     dataListTrigger.classList.remove("open");
                  } else {
                     dataListTrigger.classList.add("open");
                  }
                  
                  this.hideAutoComplete();
               });

               this._dataListTriggers.set(
                  rankName,
                  dataListTrigger
               )

               this.taxaLevels.set(count, rankInput);
               this.taxaLevelsRank.set(count, rankName);

               count++;
            }

            for (let [rank, input] of this._rankInputs) {
               input.addEventListener("keyup", this.debounceSearchRankTerm.bind(this))
               input.addEventListener("focus", this.showAutoComplete.bind(this));
               // input.addEventListener("blur", this.hideAutoComplete.bind(this));
               // input.addEventListener("change", this.changeHandler.bind(this));
            }

            this._timer = null;

            this._topWarning = this._shadow.getElementById("warningMessage");
            this._topWarningDismiss = this._shadow.getElementById("dismissMessage");
            this._topWarningRank = this._shadow.getElementById("warningMessage_rank");
            this._topWarningRankValue = this._shadow.getElementById("warningMessage_rankValue");
            this._topWarningListDiv = this._shadow.getElementById("suggestionListDiv");
            this._topWarningListList = this._shadow.getElementById("suggestionList");
            // this._clearInputButton = this._shadow.getElementById("dismissMessageClear");

            this._topWarningDismiss.addEventListener("click", () => {
               this._topWarning.hidden = true;
               this._topWarningListList.innerHTML = "";
            });


            this._searchHistory = [];
         }

         hideDataList() {
            console.log("HIDE hideDataList");
            for (let [scope, button] of this._dataListTriggers) {
               button.classList.remove("open");
            }
            for (let [scope, list] of this._scopedDataLists) {
               list.hidden = true;
            }
         }

         async changeHandler(evt) {
            this.hideAutoComplete();
            this._topWarningListList.innerHTML = "";
            console.log("changeHandler");
            const newValue = evt.target.value;

            // If this changed, and was selected from autocomplete
            // then the rest of the record is OK
            // We should have this value in stashed

            console.log(`New ${evt.target.getAttribute("rank")} value ${newValue} in stashed? ${this._stashRecords.has(newValue)}`);
            const changedRank = evt.target.getAttribute("rank");
            let possibleMatches = [];

            this._topWarningRank.textContent = changedRank;
            this._topWarningRankValue.textContent = newValue;

            const currentTarget = evt.target;
            // currentTarget.classList.toggle("border-yellow"); #TODO more visual indicators
            // this._clearInputButton.addEventListener("click", this.clear);


            if (!this._stashRecords.has(newValue)) {
               // This means it is not an option outright....
               // Show scoped options for that rank that contain these letters
               for (let [key, value] of this._stashRecords) {
                  if (value.rank == changedRank) {
                     const lowerCaseNewValue = String(newValue).toLowerCase();
                     if (String(key).toLowerCase().includes(lowerCaseNewValue)) {
                        possibleMatches.push(key);
                     }
                  }
               }
            }

            // Suggest the matches we already have before searching....
            if (possibleMatches.length == 0) {
               const info = await taxaAPI.info(newValue);
               if (info.data && info.data.length > 0) {
                  for(let result of info.data){
                     this._stashRecords.set(result.scientificname, result);
                     possibleMatches.push(result.scientificname);
                  }
               }
            }
            
            // If after checking the stashed list, and info if nothing stashed
            // And if we have some possibilities, show them
            if (possibleMatches.length !== 0) {
               for (let name of possibleMatches) {
                  const item = document.createElement("div");
                  item.textContent = name;
                  item.setAttribute("class", "clickable text-underline py-1");
                  this._topWarningListList.appendChild(item);

                  

                  item.addEventListener("click", () => {
                     this._searchInput.setValue(`${name}`);
                     this._searchTypeBool.setValue(true);
                     this._topWarning.hidden = true;
                     const itemData = this._stashRecords.get(name);
                     this.fillInData(itemData);
                  });

               }
               this._topWarningListDiv.hidden = false;
            }

            // Show the warning
            this._topWarning.hidden = false;
         }

         goBackHistory() {
            // Pop off the one and current (will be added back)
            const searchHistory =[...this._searchHistory];
            const removedItem = searchHistory.pop();    
            const data = searchHistory.pop();
            this.searchHistory = searchHistory;

            if (data && data.scientificname) {
               this._searchInput.setValue(`${data.scientificname}`);
               this.dataLayerAnimal = data;
            }

            if (searchHistory.length == 0) {
               this._goBack.hidden = true;
            } else {
               this._goBack.hidden = false;
            }
         }

         searchEnter(event) {
            event.preventDefault();
            if (event.keyCode === 13) {
               this.searchTerm();
            }
         }

         getCookie(name) {
            let value = "; " + document.cookie;
            let parts = value.split("; " + name + "=");
            if (parts.length == 2) {
               return parts.pop().split(";").shift();
            }
         }

         async applySelectedPanel() {
            const values = this.setValues();
            const formBody = JSON.stringify({ "attributes": values });
            const response = await fetch(`/rest/Localization/${this._data.id}`, {
               method: 'PATCH',
               credentials: "same-origin",
               headers: {
                  "X-CSRFToken": this.getCookie("csrftoken"),
                  "Accept": "application/json",
                  "Content-Type": "application/json"
               },
               body: formBody
            });

            // console.log(response);
            if (response.ok) {
               const data = await response.json();
               this._attrPanelMsg.innerHTML = data.message;
               this._attrPanelMsg.classList.remove("text-red");
               this._attrPanelMsg.classList.add("text-green");
            } else {
               this._attrPanelMsg.innerHTML = "Error patching data.";
               this._attrPanelMsg.classList.remove("text-green");
               this._attrPanelMsg.classList.add("text-red");
            }
            setTimeout(() => {
               this._attrPanelMsg.innerHTML = "";
            }, 2000);
            const body = JSON.stringify({ "attributes": values });
            if (typeof this.typeData.id !== "string" || String(this.typeData.id).indexOf("box") == -1) this.typeData = { ...this.typeData, id: `box_${this.typeData.id}` };
            this._dataInterface.updateType(this.typeData, this.callbackOk, '');
         }

         callbackOk() {
            console.log("Callback Ok!");
         }

         set sourceImage(val) {
            this._sourceImage = val;
            this._sourceImageEl.setAttribute("src", val);
         }

         set data(val) {
            if (val !== null) {
               this.setupData(val);
            } else {
               this.clearPanel();
            }
         }

         set dataLayerAnimal(val) {
            if (val) {
               console.log("dataLayerAnimal set to ", val);
               this.dataLayer.termId = val.AphiaID;
               this.addRowsFromRecord(val);
            } else {
               //something else? clearPanel?
            }

         }

         set searchHistory(val) {
            this._searchHistory = val;

            if (this._searchHistory.length > 1) {
               this._goBack.hidden = false;
            }
         }

         clearInputs() {
            for (let [r, rankInput] of this._rankInputs) {
               rankInput.value = "";
               rankInput.removeAttribute("aphia-id");
               const dataList = this._scopedDataLists.get(r);
               dataList.innerHTML = "";
            }
         }

         showMessage(msg) {
            this._treeList.hidden = true;
            this._treeListMessage.innerHTML = msg;
            this._treeListMessage.hidden = false;
         }

         async searchTerm() {
            const term = this._searchInput.getValue();
            // this.clearInputs();

            if (term && term !== "" && term !== "null") {
               try {
                  this.fetchSearchData(term);
               } catch (err) {
                  console.error("Couldn't get info...", err);
                  this.showMessage("No results");
               }
            }
         }

         debounceSearchRankTerm(evt) {
            const target = evt.currentTarget;
            clearTimeout(this._timer);
            this._timer = setTimeout(
               () => {
                  console.log(target.value);
                  console.log(String(target.value).length);
                  if (String(target.value).length > 3) {
                     this.searchRankTerm(target);
                  }

               }, 1500
            );
         }

         hideAutoComplete() {
            console.log("HIDE hideAutoComplete");
            for (let [rank, div] of this._autoCompleteDivs) {
               div.hidden = true;
            }
         }

         showAutoComplete(evt) {
            const target = evt.currentTarget;
            const rank = target.getAttribute("rank");
            const autocomplete = this._autoCompleteDivs.get(rank);
            
            if(autocomplete.children.length > 0){
               autocomplete.hidden = false;
            }
            
         }

         async searchRankTerm(target) {
            this.hideAutoComplete();
            const input = target;
            console.log(input);
            const term = String(input.value).trim();
            const rank = input.getAttribute("rank");
            console.log("searchTerm = " + term + ".... rank = " + rank);

            const rankId = this.rankIdMap.get(rank);

            // We're adding results here
            const autocomplete = this._autoCompleteDivs.get(rank);
            autocomplete.innerHTML = "";

            if (term && term !== "" && term !== "null") {
               try {
                  const { response, data } = await taxaAPI.info(term);

                  if (!data) {
                     this.noMatches(autocomplete);
                  } else {
                     const filteredData = data.filter(r => r.taxonRankID == rankId);

                     if (filteredData && filteredData.length > 0) {
                        this.addFilteredDataToDiv(filteredData, autocomplete);
                     } else if (data.length !== 50 && filteredData.length == 0) {
                        this.noMatches(autocomplete);
                     }
                     if (data.length === 50) {
                        this.checkForMoreData(term, rankId, autocomplete, 50);
                     }
                     autocomplete.hidden = false;
                  }

               } catch (err) {
                  this.noMatches(autocomplete);
               }
            }
         }

         async checkForMoreData(term, rankId, autocomplete, offset = 50) {
            const { response, data } = await taxaAPI.info(term, offset);

            if (data) {
               const filteredData = data.filter(r => r.taxonRankID == rankId);

               if (filteredData && filteredData.length > 0) {
                  this.addFilteredDataToDiv(filteredData, autocomplete);
               }

               if (data.length === 50) {
                  await this.checkForMoreData(term, rankId, autocomplete, (offset + 50));
               } else if (autocomplete.children.length == 0) {
                  this.noMatches(autocomplete);
               }
            } else {
               this.noMatches(autocomplete);
            }

         }

         noMatches(autocomplete) {
            this.hideAutoComplete();
            autocomplete.innerHTML = "";
            const listItem = document.createElement("div");
            listItem.setAttribute("class", "autocomplete-no-bg py-2 f1 pl-3");
            listItem.innerHTML = `
               <div class="py-2">No matches</div>
               
            `;
            autocomplete.appendChild(listItem);
            autocomplete.hidden = false;
         }

         async addFilteredDataToDiv(filteredData, autocomplete) {
            for (let result of filteredData) {
               console.log(result);
               const listItem = document.createElement("div");
               listItem.setAttribute("class", " py-2 f1 pl-3");
               listItem.innerHTML = `<div class="clickable hover-text-underline py-1">${result.scientificname}</div>`;
               listItem.addEventListener("click", async () => {
                  // Before we fill in data, check the rank below to see if it belongs to this result...
                  const input = this._rankInputs.get(result.rank);

                  if(result.scientificname !== input.value){
                     const level = this._levelNames.indexOf(result.rank);
                     const nextRank = this._levelNames[level+1];
                     const nextInput =  this._rankInputs.get(nextRank);
                     const nextInputHasData = (nextInput.value !== "" && (!nextInput.hasAttribute("aphia-id") || nextInput.getAttribute("aphia-id") !== ""));
                     console.log(`nextInputHasData ${nextInputHasData} < when false, we think it is OK not to check`);

                     let lowerListOkToClear = false;
                     if(!nextInputHasData){
                        lowerListOkToClear = true;
                     } else {
                        // lowerListOkToClear
                        const rankId = this.rankIdMap.get(nextRank);
                        const belongsToId = result.AphiaID;
                        const info = await taxaAPI.byTaxonRankID(rankId, belongsToId, 1);
                        
                        let noChildFound = true;
                        for(let n of info.data){
                           if(n.scientificname === nextInput.value) {
                              console.log(`${n.scientificname} === ${nextInput.value}`)
                              noChildFound = false;
                           }
                        }
                        console.log(`noChildFound ${noChildFound} < when true we think lowerListOkToClear (do we need to paginate?) ${info.data.length}`, info.data);
                        lowerListOkToClear = noChildFound;
                     }
                     

                     const fillIn = lowerListOkToClear;
                     
                     if(fillIn){
                        console.log("Setting results from click " + result.scientificname, result);
                        this._searchInput.setValue(`${result.scientificname}`);
                        this.fillInData(result);
                     } else {
                        input.value = result.scientificname;
                     }
                  }
                  this.hideAutoComplete();
               });
               autocomplete.appendChild(listItem);
               this._stashRecords.set(
                  result.scientificname,
                  result
               );
            }
         }

         async fillInData(record) {
            console.log("fillInData", record);
            this.clearInputs();
            let animalData = record;

            if (!animalData.hasOwnProperty("scientificname") && record[0] && record[0].hasOwnProperty("scientificname")) {
               animalData = record[0];
            }

            if (animalData) {
               this.dataLayerAnimal = animalData;
            } else {
               this.showMessage("No results");
            }
         }

         handleMultipleResults(data, term, searchScientificName) {
            const matchingResults = [];
            for (let result of data) {
               if (result.scientificname == term) {
                  matchingResults.push(result);
               }
            }

            if (matchingResults.length === 1) {
               this._searchInput.setValue(`${matchingResults[0].scientificname}`);
               this._searchTypeBool.setValue(true);
               this.fillInData(matchingResults[0]);
            } else if (matchingResults.length > 1) {
               // compare the levels and show most generic
               // More generic like Kingdom is 10 and Species is 220
               matchingResults.sort((a, b) => {
                  const aRankId = this.taxonRankID.get(a.rank);
                  const bRankId = this.taxonRankID.get(b.rank);

                  return aRankId > bRankId;
               });

               // When sorted the first should be higher rank
               this._searchInput.setValue(`${matchingResults[0].scientificname}`);
               this.fillInData(matchingResults[0]);

            } else {
               if (searchScientificName) {
                  this.showMessage(`
                  <div class="py-2 text-gray text-bold">Possible scientific names containing: "${term}":</div>
               `);
               } else {
                  this.showMessage(`
                     <div class="py-2 text-gray text-bold">Scientific names related to common name: "${term}":</div>
                  `);
               }

               for (let result of data) {
                  const listItem = document.createElement("div");
                  listItem.setAttribute("class", " py-2 f1 pl-3");
                  listItem.innerHTML = `<div class="py-2 f3 text-gray">${result.rank}</div><div class="clickable hover-text-underline">${result.scientificname}</div>`;
                  listItem.addEventListener("click", () => {
                     this._searchInput.setValue(`${result.scientificname}`);
                     this.fillInData(result);
                     this._searchTypeBool.setValue(true);
                  });
                  this._treeListMessage.appendChild(listItem);
               }
            }
         }

         async fetchSearchData(term) {
            this.clearInputs();
            const searchScientificName = this._searchTypeBool.getValue();
            const { response, data } = searchScientificName ? await taxaAPI.info(term) : await taxaAPI.infoVernacular(term);

            if (!data) {
               this.showMessage("No results");
            } else if (data.length > 1) {
               this.handleMultipleResults(data, term, searchScientificName);
            } else {
               // Sometimes it is able to read single result in array, otherwise it needs to be set to 0
               if (!data.hasOwnProperty("scientificname") && data[0] && data[0].hasOwnProperty("scientificname")) {
                  this.dataLayerAnimal = data[0];
               } else {
                  this.dataLayerAnimal = data;
               }
            }
         }

         async addRowsFromRecord(data) {
            console.log("addRowsFromRecord");
            let parentName = null;
            let previousName = null;
            let level = 0;

            this.searchHistory = [...this._searchHistory, data];

            for (let [rank, input] of this._rankInputs) {
               parentName = previousName;

               // These will change
               let nameValue = "";

               if (rank !== "Species") {
                  nameValue = data[String(rank).toLowerCase()];
               } else if (data.rank == "Species") {
                  nameValue = data.scientificname;
               }

               if (data.rank == rank) {
                  input.setAttribute("aphia-id", `${data.AphiaID}`);
               } else {
                  input.removeAttribute("aphia-id");
               }

               // This means previousRankId used for dataList parentId is only set when value isn't ""
               if (nameValue && nameValue !== "") {
                  console.log(`RANK: ${rank} ${nameValue} (${data.AphiaID}) will be the parent to the next rank. `);
                  previousName = nameValue;
               } else {
                  console.log(`Skipping setting parent for RANK: ${rank} there is no value.`);
               }
               input.value = nameValue;

               // This is async, don't await... continue loop
               this.setupRelatedFields({ nameValue, parentName, rank, input });
            }

            this._treeList.hidden = false;
            this._treeListMessage.innerHTML = "";
            this._treeListMessage.hidden = true;
         }

         async setupRelatedFields({ nameValue, parentName, rank, input }) {
            // When set from a record, we don't always have the aphia-id
            // Because the record lists out the ranks by name
            // So we set the attribute on input using a rest call
            if (nameValue && (!input.hasAttribute("aphia-id") || input.getAttribute("aphia-id") === "")) {
               const info1 = await taxaAPI.idByName(nameValue);
               const currentId = info1.data ? info1.data : "";
               input.setAttribute("aphia-id", `${currentId}`);
            }

            // And... also get parent ID from NAME
            let parentId = null;
            if (parentName && parentName !== "") {
               if (this._stashRecords.has(parentName) && this._stashRecords.get(parentName) !== null) {
                  const info = this._stashRecords.get(parentName);
                  parentId = info.AphiaID;
               } else {
                  const info = await taxaAPI.idByName(parentName);
                  parentId = info.data;
               }
            }

            // sets up datalist options relates to scoped paren and specified rank
            const dataList = this._scopedDataLists.get(rank);
            if (dataList) {
               this.setupDatalistForRank({ rankDataList: dataList, rank, currentValue: nameValue, parentId });
            }
         }

         setValues() {
            console.log("SET VALUES WAS CALLED.....")
            const values = {};
            for (const [id, input] of this.taxaLevels) {
               const rank = input.getAttribute("rank");
               values[rank] = input.value;
            }
            return values;
         }

         async setupData(val) {
            console.log(`Setup data from selection event.`, val);
            this.clearPanel();
            this._data = val;
            const mediaId = this._data.media || this._data.media_id;
            const locId = Number(String(this._data.meta).replace("box_", ""));

            const typeResp = await fetch(`/rest/LocalizationType/${locId}`);
            this.typeData = await typeResp.json();

            // // initalize (hidden) attribute panel
            // this._attributes.dataType = this.typeData;
            // this._attributes.setValues(this._data);

            const mediaResp = await fetch(`/rest/Media/${mediaId}`);
            const mediaData = await mediaResp.json();

            const animalName = mediaData.attributes["Organism Name"];
            // console.log(`animalName ${animalName} from media attr... Organism Name`);
            if (animalName) {
               this._searchInput.setValue(animalName);
               this.searchTerm();
            }
         }

         // If parentId missing parentName is required....
         async setupDatalistForRank({ rankDataList, rank, currentValue, parentId = null, parentName = null, resultList = null }) {
            rankDataList.innerHTML = "";
            if (parentId == null) {
               console.log(this._levelNames.indexOf(rank));
            }

            try {
               const currentRankId = this.rankIdMap.get(rank);
               rankDataList.setAttribute("rankScope", `${rank}`);
               rankDataList.setAttribute("belongsToId", `${parentId}`);

               if (this._stashScopedList.has(`${currentRankId}_${parentId}`)) {
                  const results = this._stashScopedList.get(`${currentRankId}_${parentId}`);
                  this.addOptions(results, rankDataList, currentRankId, parentId, -1);

               } else {
                  const info = await taxaAPI.byTaxonRankID(currentRankId, parentId);
                  const results = info.data;

                  if (results && results.length > 0) {
                     this._stashScopedList.set(`${currentRankId}_${parentId}`, results);
                     this.addOptions(results, rankDataList, currentRankId, parentId);
                  } else {
                     this._stashScopedList.set(`${currentRankId}_${parentId}`, []);
                  }
               }
            } catch (err) {
               console.error("Error setting up datalist", err);
            }
         }

         async addOptions(results, rankDataList, currentRankId, parentId, offset = 1) {
            for (let result of results) {
               const option = document.createElement("option");
               option.value = `${result.scientificname}`;
               option.innerText = `${result.scientificname}`;
               rankDataList.appendChild(option);
               this._stashRecords.set(
                  result.scientificname,
                  result
               );

               option.addEventListener("click", () => {
                  this.setupFromOptionClick(result, rankDataList);
               });
            }

            //paginate if we're at 50, but less than 300 results
            // the offset=-1 flag means don't paginate (for setting up cached results)
            if (results.length === 50 && offset < 300 && offset !== -1) {
               const info = await taxaAPI.byTaxonRankID(currentRankId, parentId, offset + 50);
               const newResults = info.data;

               if (newResults && newResults.length > 0) {
                  const current = this._stashScopedList.has(`${currentRankId}_${parentId}`) ? this._stashScopedList.get(`${currentRankId}_${parentId}`) : [];
                  this._stashScopedList.set(`${currentRankId}_${parentId}`, [...current, ...newResults]);
                  this.addOptions(newResults, rankDataList, currentRankId, parentId, offset + 50);
               }
            }
         }

         async setupFromOptionClick(item, rankDataList) {
            rankDataList.hidden = true;

            try {
               this._dataListTriggers.get(item.rank).classList.remove("open");
               if (item) {
                  const rankInput = this._rankInputs.get(item.rank);
                  if(rankInput.value !== item.scientificname){
                     rankInput.value = item.scientificname;
                     rankInput.setAttribute("aphia-id", item.AphiaId);

                     const level = Number(rankInput.getAttribute("level"));
                     this._searchInput.setValue(`${item.scientificname}`);
                     this._searchTypeBool.setValue(true);
                     this.fillInData(item);
                  }
                  // this._clearChildAndDatalists((level + 1), item.AphiaId);
               }
            } catch (err) {
               console.error("Couldn't set up record from option selected....", err);
            }
         }

         clearPanel() {
            this.imageContainerDiv.hidden = true;
            // this._descriptiveText.hidden = true;
            this._searchInput.setValue("");
            this.dataLayerAnimal = null;
            this.clearInputs();
            this.showMessage("Search to start.");
         }
      }

      customElements.define("tools-applet-panel-html", ToolsAppletPanelHTML);

      class ToolsApplet extends tatorUi.annotation.ToolsAppletElement {
         constructor(children) {
            super();

            this._closeApplet = document.createElement("div");
            this._closeApplet.setAttribute("class", "float-right clickable");
            this._closeApplet.innerHTML = `<svg viewBox="0 0 24 24" height="2em" width="2em"><title>Close</title><path d="M5.293 6.707l5.293 5.293-5.293 5.293c-0.391 0.391-0.391 1.024 0 1.414s1.024 0.391 1.414 0l5.293-5.293 5.293 5.293c0.391 0.391 1.024 0.391 1.414 0s0.391-1.024 0-1.414l-5.293-5.293 5.293-5.293c0.391-0.391 0.391-1.024 0-1.414s-1.024-0.391-1.414 0l-5.293 5.293-5.293-5.293c-0.391-0.391-1.024-0.391-1.414 0s-0.391 1.024 0 1.414z"></path></svg>`;
            this._shadow.appendChild(this._closeApplet);

            this._panel = document.createElement("tools-applet-panel-html");
            this._shadow.appendChild(this._panel);
         }

         // @TODO - should I just pass the entire annotation page?
         async init({ canvas = null, canvasElement = null, data = null }) {

            this._canvas = canvas;
            this._canvasElement = canvasElement;
            this._panel._dataInterface = data;
            this._panel.closeApplet = this._closeApplet;
            this._panel.hidden = true;

            this._mediaCanvas = null;

            if ('_video' in this._canvas) {
               this._mediaCanvas = this._canvas._video;
            }

            if ('_image' in this._canvas) {
               this._mediaCanvas = this._canvas._image;
            }

            // Complete definition of icon by added an svg
            const detailObject = {
               detail:
               {
                  name: appletName,
                  icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="no-fill"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>`
               }
            };
            this.dispatchEvent(new CustomEvent("icon-ready", detailObject));

            // Listen to applet close click
            this._closeApplet.addEventListener("click", () => {
               // console.log("Close applet!");
               this.dispatchEvent(new Event("closeApplet"));
               this.clearAll()
            });

            // this._canvas.addEventListener("create", this.updateFromCreate.bind(this));

            this._canvas.addEventListener("select", this.updateFromSelect.bind(this));
         }

         async updateFromSelect(e) {
            // console.log(`Canvas - SELECT inside ${appletName}`, e);
            const localization = e.detail;
            this._panel.hidden = false;
            this._updateImage(localization);
            this._panel.data = localization;

         }

         updateFromCreate(e) {
            // console.log(`Canvas - CREATE inside ${appletName}`, e);
            const localization = e.detail.requestObj;
            localization.meta = e.detail.objDescription.id;
            this._updateImage(localization);
         }

         _updateImage(localization) {
            // console.log("_updateImage", localization);
            if (this._mediaCanvas.currentFrame() == localization.frame) {
               this._mediaCanvas.moveToLocalization(localization);
               this.setupPNG();
            } else {
               this._mediaCanvas.seekFrame(localization.frame,
                  (frameIdx, source, width, height) => {
                     this._mediaCanvas.updateOffscreenBuffer(frameIdx, source, width, height);
                     this._mediaCanvas.moveToLocalization(localization);
                     this.setupPNG();

                     // Put the off screen back to normal
                     this._mediaCanvas.seekFrame(this._mediaCanvas.currentFrame(),
                        (frameIdx, source, width, height) => {
                           this._mediaCanvas.updateOffscreenBuffer(frameIdx, source, width, height);
                        });
                  });
            }
         }

         clearAll() {
            this._panel.clearPanel();
         }

         async setupPNG() {
            const png_data = await this._mediaCanvas.getPNGdata(false);

            var png_file = URL.createObjectURL(png_data);
            this._panel.sourceImage = png_file;

            // reset to where we where
            this._mediaCanvas.moveOffscreenBuffer(this._mediaCanvas._roi);

         }
      }

      customElements.define("tools-applet", ToolsApplet);
   </script>
   <div class="py-1">
      <tools-applet id="toolsApplet"></tools-applet>
   </div>
</body>

</html>